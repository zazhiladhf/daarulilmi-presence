<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - {{.SchoolName}}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      :root {
        --sidebar-width: 280px;
      }
      body {
        background-color: #f4f7f6;
      }
      .main-container {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-width);
        flex-shrink: 0;
        background-color: #fff;
        border-right: 1px solid #dee2e6;
      }
      .sidebar .nav-link {
        color: #333;
        font-weight: 500;
        border-radius: 0.375rem;
      }
      .sidebar .nav-link:hover {
        background-color: #e9ecef;
      }
      .sidebar .nav-link.active {
        background-color: #0d6efd;
        color: white;
      }
      .sidebar .nav-link .bi {
        margin-right: 0.75rem;
      }
      .content {
        flex-grow: 1;
        width: calc(100% - var(--sidebar-width));
        display: flex;
        flex-direction: column;
      }
      .main-header {
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .dropdown-toggle::after {
        display: none;
      }
      .page-content {
        flex-grow: 1;
      }
      @media (max-width: 991.98px) {
        .sidebar {
          position: fixed;
          top: 0;
          bottom: 0;
          left: 0;
          z-index: 1045;
          transform: translateX(-100%);
          transition: transform 0.3s ease-in-out;
        }
        .sidebar.show {
          transform: translateX(0);
        }
        .content {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      {{template "_sidebar.html" .}}

      <div class="content">
        {{template "_header.html" .}}

        <main class="page-content p-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <div>
              <h1 class="h2" id="welcome-message">Memuat...</h1>
              <p class="text-muted" id="live-datetime">Memuat waktu...</p>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-4 col-md-6 mb-3">
              <div class="card text-white bg-primary shadow-sm">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <h5 class="card-title mb-0">Total Siswa</h5>
                      <p class="card-text fs-2 fw-bold" id="total-siswa">0</p>
                    </div>
                    <i class="bi bi-people-fill fs-1 opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-3">
              <div class="card text-white bg-success shadow-sm">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <h5 class="card-title mb-0">Hadir</h5>
                      <p class="card-text fs-2 fw-bold" id="total-hadir">0</p>
                    </div>
                    <i class="bi bi-person-check-fill fs-1 opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 col-md-12 mb-3">
              <div class="card text-white bg-secondary shadow-sm">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <h5 class="card-title mb-0">Belum Ada Kabar</h5>
                      <p class="card-text fs-2 fw-bold" id="total-absen">0</p>
                    </div>
                    <i class="bi bi-person-exclamation fs-1 opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-lg-7 col-md-12 mb-3">
              <div class="card shadow-sm">
                <div class="card-header">
                  <i class="bi bi-list-check"></i> Rekap Kehadiran Hari Ini
                </div>
                <div
                  class="card-body table-responsive"
                  style="max-height: 300px"
                >
                  <table class="table table-striped table-sm">
                    <thead>
                      <tr>
                        <th>Waktu</th>
                        <th>NISN</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="tabel-hadir"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-lg-5 col-md-12 mb-3">
              <div class="card shadow-sm">
                <div class="card-header">
                  <i class="bi bi-journal-medical"></i> Siswa Izin Hari Ini
                </div>
                <div
                  class="card-body table-responsive"
                  style="max-height: 300px"
                >
                  <table class="table table-striped table-sm">
                    <thead>
                      <tr>
                        <th>NISN</th>
                        <th>Jenis Izin</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="tabel-izin"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="card mt-3 shadow-sm">
            <div class="card-header">Generate QR Code Absensi</div>
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-7">
                  <p class="mb-2">
                    Klik tombol untuk menampilkan QR code absensi masuk atau
                    pulang. QR code hanya valid selama 60 detik.
                  </p>
                  <button id="generate-qr-btn" class="btn btn-success mb-2">
                    <i class="bi bi-box-arrow-in-right"></i> Tampilkan QR Masuk</button
                  ><button
                    id="generate-qr-pulang-btn"
                    class="btn btn-danger mb-2"
                  >
                    <i class="bi bi-box-arrow-left"></i> Tampilkan QR Pulang
                  </button>
                </div>
                <div class="col-md-5 text-center">
                  <h5 id="qr-title" class="d-none">Scan QR Code Ini</h5>
                  <img
                    id="qr-code-img"
                    src=""
                    alt="QR Code akan muncul di sini"
                    class="img-fluid border rounded"
                    style="max-width: 256px; display: none"
                  />
                  <p id="qr-loading" style="display: none">Memuat QR Code...</p>
                </div>
              </div>
            </div>
          </div>
        </main>

        <footer class="footer mt-auto py-3 bg-white border-top">
          <div class="container-fluid text-center">
            <span class="text-muted"
              >&copy; {{.CurrentYear}} {{.SchoolName}}.</span
            >
          </div>
        </footer>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Deklarasikan token di scope paling atas agar bisa diakses semua fungsi
        const token = localStorage.getItem("jwt_token");

        // Skrip logout & get username ditaruh di layout saja, tapi untuk keamanan kita taruh di sini juga
        function handleLogout(e) {
          e.preventDefault();
          localStorage.removeItem("jwt_token");
          window.location.href = "/";
        }
        document
          .getElementById("logout-button-header")
          ?.addEventListener("click", handleLogout);
        document
          .getElementById("logout-button-sidebar")
          ?.addEventListener("click", handleLogout);

        if (!token) {
          window.location.href = "/";
          return;
        }

        // ===========================================
        // BAGIAN 1: MENGAMBIL & MENAMPILKAN DATA
        // ===========================================
        fetch("/api/dashboard-data", {
          headers: { Authorization: "Bearer " + token },
        })
          .then((response) => {
            if (!response.ok) throw new Error("Gagal memuat data dashboard.");
            return response.json();
          })
          .then((data) => {
            // Isi nama di Header & Sidebar
            const userDisplayHeader = document.getElementById(
              "user-display-name-header"
            );
            const userDisplaySidebar = document.getElementById(
              "user-display-name-sidebar"
            );
            if (userDisplayHeader) userDisplayHeader.innerText = data.Username;
            if (userDisplaySidebar)
              userDisplaySidebar.innerText = data.Username;

            // Isi konten di halaman ini
            document.getElementById(
              "welcome-message"
            ).innerText = `Selamat Datang, ${data.NamaLengkap}!`;
            document.getElementById("total-siswa").innerText = data.TotalSiswa;
            document.getElementById("total-hadir").innerText =
              data.TotalHadirHariIni;
            document.getElementById("total-absen").innerText =
              data.TotalBelumAdaKabar;

            const tabelHadir = document.getElementById("tabel-hadir");
            if (
              data.LogKehadiranHariIni &&
              data.LogKehadiranHariIni.length > 0
            ) {
              let rows = "";
              data.LogKehadiranHariIni.forEach((log) => {
                let time = new Date(log.Timestamp).toLocaleTimeString("id-ID", {
                  hour: "2-digit",
                  minute: "2-digit",
                });
                rows += `<tr><td>${time}</td><td>${log.Username}</td><td><span class="badge bg-success">${log.Status}</span></td></tr>`;
              });
              tabelHadir.innerHTML = rows;
            } else {
              tabelHadir.innerHTML =
                '<tr><td colspan="3" class="text-center text-muted">Belum ada siswa yang hadir.</td></tr>';
            }

            const tabelIzin = document.getElementById("tabel-izin");
            if (data.SiswaIzinHariIni && data.SiswaIzinHariIni.length > 0) {
              let rows = "";
              data.SiswaIzinHariIni.forEach((req) => {
                rows += `<tr><td>${req.SiswaNISN}</td><td>${req.JenisIzin}</td><td><span class="badge bg-warning text-dark">${req.Status}</span></td></tr>`;
              });
              tabelIzin.innerHTML = rows;
            } else {
              tabelIzin.innerHTML =
                '<tr><td colspan="3" class="text-center text-muted">Tidak ada siswa yang izin hari ini.</td></tr>';
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("welcome-message").innerText =
              "Gagal memuat data. Sesi mungkin telah habis. Silakan login kembali.";
          });

        // ===========================================
        // BAGIAN 2: JAM & TANGGAL DINAMIS
        // ===========================================
        const dateTimeElement = document.getElementById("live-datetime");
        function updateDateTime() {
          const now = new Date();
          const date = now.toLocaleDateString("id-ID", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          const time = now.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
          if (dateTimeElement) {
            dateTimeElement.innerText = `Waktu Saat Ini: ${date} pukul ${time}`;
          }
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // ===========================================
        // BAGIAN 3: GENERATE QR CODE
        // ===========================================
        const generateBtn = document.getElementById("generate-qr-btn");
        const generatePulangBtn = document.getElementById(
          "generate-qr-pulang-btn"
        );
        const qrImg = document.getElementById("qr-code-img");
        const qrLoading = document.getElementById("qr-loading");
        const qrTitle = document.getElementById("qr-title");

        function fetchQRCode(type) {
          qrImg.style.display = "none";
          qrLoading.style.display = "block";
          qrTitle.style.display = "block";
          qrTitle.innerText = `Memuat QR Code Absen ${type}...`;

          fetch("/api/qr/generate", {
            method: "GET",
            headers: { Authorization: "Bearer " + token }, // Variabel token sekarang bisa diakses di sini
          })
            .then((response) => response.blob())
            .then((blob) => {
              qrImg.src = URL.createObjectURL(blob);
              qrImg.style.display = "block";
              qrLoading.style.display = "none";
              qrTitle.innerText = `Scan QR Code Absen ${type}`;
            })
            .catch((error) => {
              console.error("Error fetching QR code:", error);
              qrTitle.innerText = "Gagal Memuat QR Code";
            });
        }
        generateBtn.addEventListener("click", () => fetchQRCode("Masuk"));
        generatePulangBtn.addEventListener("click", () =>
          fetchQRCode("Pulang")
        );
      });
    </script>
  </body>
</html>
